 <!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Impostor — Juego</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#071025; --card:#0b1220; --accent:#7CE3B4; --muted:#94a3b8; --danger:#FF6B6B; --glass: rgba(255,255,255,0.03);
  --btn:#5B8CFF; --btn2:#7CE3B4;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
body{margin:0;background:linear-gradient(180deg,#061021 0%, #071025 100%);color:#e6eef8;min-height:100vh}
.wrap{max-width:1150px;margin:18px auto;padding:14px}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
h1{font-weight:700;margin:0;font-size:18px}
.grid{display:grid;grid-template-columns:320px 1fr 320px;gap:14px}
.card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(2,6,23,0.5)}
input,select,button,textarea{border-radius:999px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);padding:10px;color:inherit}
button{cursor:pointer;outline:none;font-weight:600}
.muted{color:var(--muted);font-size:13px}
.left .section{margin-bottom:12px}
.inviteBox{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border-radius:12px}
.playersList{list-style:none;padding:0;margin:8px 0;max-height:340px;overflow:auto}
.playersList li{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:rgba(255,255,255,0.01);margin-bottom:8px}
.playersList li.active{box-shadow:0 0 0 3px rgba(123,198,255,0.06);background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005))}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.controls button{flex:1;padding:10px;border-radius:30px}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
.btn-danger{background:var(--danger);color:#111;border-radius:30px}
.small{font-size:13px;padding:8px;border-radius:30px}
.roleCard{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01))}
.roleBig{font-weight:700;font-size:20px}
.wordBox{margin-top:10px;padding:12px;border-radius:12px;background:rgba(255,255,255,0.02)}
.timer{font-size:22px;font-weight:700;color:var(--btn)}
.votingPanel{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005))}
.voteRow{display:flex;align-items:center;gap:12px;padding:8px;border-radius:999px;margin-bottom:8px;background:rgba(255,255,255,0.01);cursor:pointer}
.voteRow.disabled{opacity:0.5;cursor:not-allowed}
.voteName{width:40%}
.voteBar{flex:1;height:18px;background:rgba(255,255,255,0.03);border-radius:999px;position:relative;overflow:hidden}
.voteFill{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg,var(--btn),var(--btn2));width:0%}
.voteCount{width:40px;text-align:right;font-weight:600}
.voteSubmit{width:100%;padding:12px;border-radius:30px;background:var(--btn);color:#052044;border:none;font-weight:700}
.impostorChat{padding:12px;border-radius:12px;background:linear-gradient(180deg,#07132a,#071425);max-height:320px;overflow:auto}
.msg{padding:8px;border-radius:10px;margin-bottom:8px;background:rgba(255,255,255,0.02)}
.msg.self{background:linear-gradient(90deg, rgba(92,140,255,0.2), rgba(124,227,180,0.08));}
.bigAction{padding:12px 18px;border-radius:30px;background:var(--btn);color:#052044;border:none;font-weight:700}
@media(max-width:1100px){ .grid{grid-template-columns:1fr; padding-bottom:30px} .card{margin-bottom:12px} }
</style>
</head>
<body>
<div class="wrap">
  <header style="display:flex;align-items:center;justify-content:space-between">
    <h1>Impostor — Juego</h1>
    <div class="muted">Multijugador • Firebase</div>
  </header>

  <div class="grid">
    <!-- LEFT: Lobby -->
    <div class="card left">
      <div style="margin-bottom:12px">
        <label class="muted">Tu nombre</label>
        <input id="playerName" placeholder="Ej: Ana">
      </div>

      <div style="margin-bottom:12px">
        <label class="muted">Número de sala (solo unirse)</label>
        <input id="joinRoomNumber" placeholder="Ej: 1234">
      </div>

      <div style="margin-bottom:12px">
        <label class="muted">Jugadores requeridos (solo admin)</label>
        <input id="numPlayers" type="number" placeholder="Ej: 8">
      </div>

      <div class="controls" style="margin-bottom:12px">
        <button id="createRoomBtn" class="bigAction">Crear Sala</button>
        <button id="joinRoomBtn" class="btn-ghost small">Unirse</button>
      </div>

      <div class="inviteBox" style="margin-bottom:12px">
        <div class="muted">Sala</div>
        <div id="roomInfo" style="font-weight:700;margin-top:6px">—</div>
        <div style="margin-top:8px" class="muted">Link de invitación:</div>
        <div id="inviteLink" style="margin-top:6px;word-break:break-all;color:var(--accent)">—</div>
      </div>

      <div style="margin-bottom:12px">
        <h3 style="margin-bottom:8px">Jugadores</h3>
        <ul id="playersList" class="playersList"></ul>
      </div>

      <div>
        <h3 style="margin-bottom:8px">Chat privado — Impostores</h3>
        <div id="impostorChatContainer" style="display:none">
          <div id="impostorChat" class="impostorChat"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="impostorMsg" placeholder="Mensaje a impostores..." style="flex:1;border-radius:20px;padding:10px">
            <button id="sendImpostor" class="small">Enviar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CENTER: Game -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div>
          <div class="muted">Sala</div>
          <div id="roomNumber" style="font-weight:700;font-size:18px">—</div>
        </div>
        <div style="text-align:right">
          <div class="muted">Turno actual</div>
          <div id="turnInfo" class="timer">—</div>
        </div>
      </div>

      <div class="roleCard">
        <div>
          <div class="muted">Tu rol</div>
          <div id="roleDisplay" class="roleBig">—</div>
          <div class="muted" style="margin-top:6px">Tu palabra / pista (privado)</div>
          <div id="wordDisplay" class="wordBox">—</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <select id="categorySelect" style="flex:1;border-radius:30px;padding:10px"></select>
        <button id="startGameBtn" class="small" style="border-radius:30px;background:var(--btn);color:#052044">Iniciar</button>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="nextTurnBtn" class="btn-ghost small" style="border-radius:30px">Siguiente Turno (Admin)</button>
        <button id="enableVoteBtn" class="btn-ghost small" style="border-radius:30px">Forzar Votación</button>
        <button id="endGameBtn" class="btn-danger small">Finalizar</button>
      </div>

      <div style="margin-top:16px">
        <div class="muted">Cronómetro</div>
        <div id="timer" style="font-size:28px;font-weight:700;color:var(--btn);margin-top:6px">60s</div>
        <div id="roundInfo" class="muted" style="margin-top:8px">Rondas completadas: 0</div>
      </div>

      <div style="margin-top:12px">
        <h3 style="margin-bottom:8px">Lista de jugadores</h3>
        <ul id="playersCenterList" class="playersList"></ul>
      </div>
    </div>

    <!-- RIGHT: Voting -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div><strong>Votación</strong></div>
        <div class="muted">Estado: <span id="votingStatus">Bloqueada</span></div>
      </div>

      <div class="votingPanel" id="votingPanel">
        <div id="voteRows"></div>
        <button id="voteSubmitBtn" class="voteSubmit" disabled>Enviar mi voto</button>
        <div class="muted" style="margin-top:8px">Haz click en una barra para seleccionar a quién votar. Las barras muestran conteo en tiempo real.</div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase (compat para poder abrir directamente desde file://) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* === Config Firebase: conserva la tuya si ya tienes una === */
const firebaseConfig = {
  apiKey: "AIzaSyAig1kHcEgjf-ncLUN2Vc2ZKBCC4sFHZWs",
  authDomain: "impostor-35ecf.firebaseapp.com",
  databaseURL: "https://impostor-35ecf-default-rtdb.firebaseio.com/",
  projectId: "impostor-35ecf",
  storageBucket: "impostor-35ecf.appspot.com",
  messagingSenderId: "351796401652",
  appId: "1:351796401652:web:fc1d656503fdd0fc08d5a1",
  measurementId: "G-5YQYFFB4T1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* === Categorías: 30 categorías x 25 palabras cada una === */
const categories = {
  frutas: ["Manzana","Banana","Pera","Fresa","Naranja","Sandía","Mango","Kiwi","Uva","Cereza","Melón","Papaya","Piña","Durazno","Ciruela","Frambuesa","Arándano","Limón","Mandarina","Pomelo","Coco","Granada","Higo","Litchi","Guayaba"],
  animales: ["Perro","Gato","León","Tigre","Elefante","Jirafa","Cebra","Mono","Lobo","Oso","Rinoceronte","Hipopótamo","Conejo","Caballo","Vaca","Cerdo","Oveja","Pato","Gallina","Pez","Tortuga","Serpiente","Cocodrilo","Loro","Murciélago"],
  ciudades: ["París","Londres","Nueva York","Tokio","Madrid","Roma","Berlín","Lisboa","Barcelona","Sídney","Moscú","Beijing","Ámsterdam","Bangkok","Estambul","Dubai","Los Ángeles","Chicago","Buenos Aires","Seúl","Hong Kong","Toronto","Miami","San Petersburgo","Delhi","Praga"],
  colores: ["Rojo","Azul","Verde","Amarillo","Negro","Blanco","Rosa","Morado","Naranja","Gris","Marrón","Cian","Magenta","Violeta","Turquesa","Dorado","Plateado","Beige","Lila","Celeste","Oliva","Salmón","Borgoña","Índigo","Coral"],
  objetos: ["Mesa","Silla","Lámpara","Libro","Bolígrafo","Teléfono","Reloj","Computadora","Cuchara","Tenedor","Cuchillo","Ventana","Puerta","Zapato","Sombrero","Bolsa","Cartera","Guitarra","Televisor","Cámara","Espejo","Almohada","Cojín","Silla de ruedas","Paraguas"],
  peliculas: ["Titanic","Avatar","Inception","Gladiador","Matrix","El Padrino","Forrest Gump","Star Wars","Jurassic Park","Shrek","Frozen","El Rey León","Harry Potter","Joker","Interestelar","Spider-Man","Avengers","La La Land","Toy Story","Casablanca","El Señor de los Anillos","Up","Coco","Rapido y Furioso","Piratas del Caribe"],
  musica: ["Beatles","Queen","Michael Jackson","Madonna","Elton John","Beyoncé","Adele","Taylor Swift","Shakira","Coldplay","U2","AC/DC","Eminem","Drake","Ed Sheeran","Bruno Mars","Rihanna","Katy Perry","Justin Bieber","Lady Gaga","Linkin Park","Pink Floyd","Bob Marley","The Rolling Stones","David Bowie"],
  ciencia: ["Átomo","Molécula","Energía","Gravedad","Célula","Neurona","ADN","Gen","Fotosíntesis","Electrón","Protones","Quarks","Relatividad","Órbita","Planeta","Galaxia","Cometa","Virus","Bacteria","Fósil","Evolución","Hongo","Mineral","Oxígeno","Nitrógeno"],
  tecnologia: ["Computadora","Internet","Robot","Inteligencia Artificial","Smartphone","Tablet","Redes","Cámara","Impresora","Dron","Software","Hardware","Aplicación","WiFi","Bluetooth","Ciberseguridad","Procesador","Memoria","Disco Duro","Pantalla","Teclado","Ratón","Auriculares","Monitor","Servidor"],
  transporte: ["Coche","Bicicleta","Avión","Tren","Barco","Autobús","Moto","Camión","Submarino","Helicóptero","Tranvía","Metro","Monopatín","Patinete","Taxi","Furgoneta","Tractor","Caravana","Jet","Globo","Velero","Remo","Lancha","Ferry","Teleférico"],
  deportes: ["Fútbol","Baloncesto","Tenis","Béisbol","Golf","Natación","Boxeo","Rugby","Voleibol","Ciclismo","Atletismo","Esquí","Snowboard","Surf","Hockey","Skate","Karate","Taekwondo","Judo","Ping Pong","Bolos","Motocross","Escalada","Paracaidismo","Lucha libre"],
  animales_domesticos: ["Perro","Gato","Conejo","Pez","Hamster","Cobaya","Canario","Loro","Tortuga","Serpiente","Gallo","Pato","Caballo","Cabra","Oveja","Cerdo","Ratón","Hurón","Camaleón","Erizo","Gato Siamés","Pastor Alemán","Bulldog","Persa","Acuario"],
  comidas: ["Pizza","Hamburguesa","Sushi","Tacos","Paella","Ensalada","Pollo","Carne","Pasta","Arroz","Sopa","Pescado","Fruta","Verdura","Helado","Chocolate","Pan","Queso","Huevos","Galleta","Cereal","Crepa","Tortilla","Arepa","Empanada"],
  bebidas: ["Agua","Jugo","Café","Té","Cerveza","Vino","Refresco","Leche","Smoothie","Batido","Champán","Vodka","Whisky","Ron","Tequila","Sidra","Limonada","Mojito","Coca-Cola","Fanta","Sprite","Ginger Ale","Matcha","Mate","Chai"],
  estaciones: ["Primavera","Verano","Otoño","Invierno","Lluviosa","Seca","Fría","Caliente","Templada","Nevada","Húmeda","Vientos","Soleada","Nublada","Tormenta","Trueno","Relámpago","Aurora","Crepúsculo","Mañana","Tarde","Noche","Medianoche","Amanecer","Atardecer"],
  instrumentos: ["Guitarra","Piano","Batería","Violín","Flauta","Saxofón","Trompeta","Clarinete","Chelo","Arpa","Órgano","Acordeón","Tambor","Ukelele","Trombón","Corneta","Gong","Marimba","Xilófono","Castañuelas","Banjo","Timbal","Mandolina","Oboe","Fagot"],
  herramientas: ["Martillo","Destornillador","Taladro","Sierra","Alicate","Llave inglesa","Cúter","Cinta métrica","Nivel","Pala","Rastrillo","Tornillo","Clavo","Soplete","Taladro percutor","Tenazas","Sierra circular","Escuadra","Compás","Lima","Broca","Prensa","Sargentos","Flexómetro","Cepillo"],
  ropa: ["Camisa","Pantalón","Zapatos","Calcetines","Sombrero","Gorra","Chaqueta","Abrigo","Falda","Vestido","Cinturón","Bufanda","Guantes","Traje","Corbata","Botas","Sandalias","Chaleco","Pijama","Bata","Leggings","Shorts","Jeans","Camiseta","Sudadera"],
  animales_salvajes: ["León","Tigre","Elefante","Jirafa","Cebra","Hipopótamo","Rinoceronte","Oso","Lobo","Cocodrilo","Canguro","Jaguar","Pantera","Lince","Zorro","Búho","Águila","Lémur","Orangután","Gorila","Bisonte","Antílope","Hiena","Coyote","Serpiente"],
  emociones: ["Felicidad","Tristeza","Enojo","Miedo","Sorpresa","Amor","Odio","Alegría","Ansiedad","Confusión","Vergüenza","Celos","Frustración","Nostalgia","Entusiasmo","Orgullo","Satisfacción","Desesperación","Paz","Calma","Inquietud","Gratitud","Desdén","Curiosidad","Asombro"],
  muebles: ["Silla","Mesa","Cama","Armario","Escritorio","Estantería","Sofá","Lámpara","Banco","Taburete","Aparador","Cómoda","Vitrina","Perchero","Sillón","Mueble TV","Mesita","Zapatero","Mueble de cocina","Cama doble","Litera","Cuna","Butaca","Silla de oficina","Banco de trabajo"],
  transporte_publico: ["Autobús","Metro","Tren","Tranvía","Taxi","Uber","Mototaxi","Teleférico","Ferry","Bote","Tren ligero","Bus turístico","Trolebús","Monorraíl","Vagón","Coche compartido","Scooter","Motocicleta","Bicicleta pública","Camión urbano","Barco","Lancha","Furgoneta","Submarino","Helicóptero"],
  herramientas_cocina: ["Cuchillo","Tenedor","Cuchara","Cucharón","Espátula","Colador","Olla","Sartén","Batidora","Procesador","Rallador","Tijeras","Mortero","Tabla de cortar","Exprimidor","Cazo","Cucharita","Pinzas","Termómetro","Ramequin","Fuente","Recipiente","Moldes","Molde de pan","Cafetera"],
  tecnologia_antigua: ["Teléfono fijo","Máquina de escribir","Disquete","Televisor CRT","Radio antigua","Fax","Gramófono","Proyector","VHS","Walkman","Discman","Cámara analógica","Reloj de arena","Pizarra","Calculadora mecánica","Telégrafo","Linterna","Cinta VHS","Teléfono rotativo","Reproductor DVD","Discoteca","Cámara Polaroid","Videocámara","Scanner","Proyector de diapositivas"],
  politica: ["Joe Biden","Barack Obama","Angela Merkel","Nelson Mandela","Vladimir Putin","Winston Churchill","Margaret Thatcher","Mahatma Gandhi","Emmanuel Macron","Xi Jinping","Donald Trump","Fidel Castro","Jair Bolsonaro","Justin Trudeau","Jacinda Ardern","Abraham Lincoln","Franklin Roosevelt","Theodore Roosevelt","John F. Kennedy","Hillary Clinton","Kamala Harris","Benjamin Netanyahu","Catherine de Medici","Cleopatra","Napoleón"],
  futbol: ["Lionel Messi","Cristiano Ronaldo","Diego Maradona","Pelé","Zinedine Zidane","Neymar","Kylian Mbappé","Johan Cruyff","Ronaldinho","David Beckham","Sergio Ramos","Luka Modrić","Paolo Maldini","Thierry Henry","Andrés Iniesta","Luis Suárez","Robert Lewandowski","Eden Hazard","Harry Kane","Gianluigi Buffon","Wayne Rooney","Karim Benzema","Marcelo","Ronaldo Nazário","Iker Casillas"]
};

/* === Helpers y referencias DOM === */
const $ = id => document.getElementById(id);
const playerNameInput = $('playerName');
const joinRoomInput = $('joinRoomNumber');
const numPlayersInput = $('numPlayers');
const createRoomBtn = $('createRoomBtn');
const joinRoomBtn = $('joinRoomBtn');
const roomInfo = $('roomInfo');
const inviteLink = $('inviteLink');
const playersListEl = $('playersList');
const playersCenterList = $('playersCenterList');
const roomNumberEl = $('roomNumber');
const roleDisplay = $('roleDisplay');
const wordDisplay = $('wordDisplay');
const categorySelect = $('categorySelect');
const startGameBtn = $('startGameBtn');
const nextTurnBtn = $('nextTurnBtn');
const enableVoteBtn = $('enableVoteBtn');
const endGameBtn = $('endGameBtn');
const timerEl = $('timer');
const roundInfoEl = $('roundInfo');
const impostorChatContainer = $('impostorChatContainer');
const impostorChat = $('impostorChat');
const impostorMsg = $('impostorMsg');
const sendImpostor = $('sendImpostor');
const voteRows = $('voteRows');
const voteSubmitBtn = $('voteSubmitBtn');
const votingStatus = $('votingStatus');

/* === Estado local === */
let room = null;
let playerId = null;
let playerName = null;
let isAdmin = false;
let players = []; // local snapshot array
let currentTurn = null;
let turnEndTimestamp = null;
let timerInterval = null;
let votingActive = false;
let myVote = null;

/* === Llenar categorías === */
for(const cat in categories){
  const opt = document.createElement('option');
  opt.value = cat;
  opt.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
  categorySelect.appendChild(opt);
}

/* === Util === */
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
function now(){ return Date.now(); }

/* ===========================
   Crear / Unirse a sala
   =========================== */
createRoomBtn.addEventListener('click', ()=>{
  playerName = playerNameInput.value.trim() || "Anon";
  playerId = uid();
  isAdmin = true;
  const required = parseInt(numPlayersInput.value) || 4;
  const roomId = String(Math.floor(1000 + Math.random()*9000));
  room = roomId;

  // inicializar estructura de sala
  db.ref('rooms/'+room+'/meta').set({
    requiredPlayers: required,
    status: 'lobby',
    category: null,
    currentTurnPlayer: null,
    turnEnd: null,
    voting: false
  });
  // crear jugador admin
  db.ref('rooms/'+room+'/players/'+playerId).set({
    name: playerName,
    admin: true,
    role: null,
    word: null,
    alive: true,
    votedFor: null
  });

  roomInfo.textContent = room;
  inviteLink.textContent = `${location.origin}${location.pathname}?room=${room}`;
  roomNumberEl.textContent = room;
  listenRoom(room);
});

joinRoomBtn.addEventListener('click', ()=>{
  playerName = playerNameInput.value.trim() || "Anon";
  playerId = uid();
  isAdmin = false;
  const joinId = joinRoomInput.value.trim();
  if(!joinId){ alert("Ingresa número de sala"); return; }
  room = joinId;

  db.ref('rooms/'+room+'/players/'+playerId).set({
    name: playerName,
    admin: false,
    role: null,
    word: null,
    alive: true,
    votedFor: null
  });

  roomInfo.textContent = room;
  inviteLink.textContent = `${location.origin}${location.pathname}?room=${room}`;
  roomNumberEl.textContent = room;
  listenRoom(room);
});

/* Reconectar si room en URL */
(function initFromURL(){
  const p = new URLSearchParams(window.location.search);
  if(p.has('room')){
    const r = p.get('room');
    room = r;
    roomInfo.textContent = room;
    inviteLink.textContent = `${location.origin}${location.pathname}?room=${room}`;
    roomNumberEl.textContent = room;
    // don't set player until they press join or create
  }
})();

/* ===========================
   Escuchar datos de la sala
   =========================== */
function listenRoom(roomId){
  // players
  db.ref('rooms/'+roomId+'/players').on('value', snap=>{
    const val = snap.val() || {};
    players = Object.entries(val).map(([id,p])=>({id,...p}));
    renderPlayers();
    // If our player is present, update local admin flag
    const me = players.find(p=>p.id===playerId);
    if(me) isAdmin = !!me.admin;
  });

  // meta
  db.ref('rooms/'+roomId+'/meta').on('value', snap=>{
    const m = snap.val();
    if(!m) return;
    // update category display / voting state / turn
    votingActive = !!m.voting;
    votingStatus.textContent = votingActive ? 'Activa' : 'Bloqueada';
    // turn info
    currentTurn = m.currentTurnPlayer || null;
    turnEndTimestamp = m.turnEnd || null;
    if(currentTurn){
      const p = players.find(x=>x.id===currentTurn);
      $('turnInfo').textContent = p? p.name : '—';
      startLocalTimer();
    }
    // category
    if(m.category) categorySelect.value = m.category;
    // show role/word for me (will be updated by players listener too)
    const me = players.find(p=>p.id===playerId);
    if(me){
      roleDisplay.textContent = me.role || '—';
      wordDisplay.textContent = (me.role==='Impostor')? 'CATEGORÍA' : (me.word || '—');
      impostorChatContainer.style.display = (me.role==='Impostor') ? 'block' : 'none';
    }
  });

  // impostor chat
  db.ref('rooms/'+roomId+'/impostorChat').on('value', snap=>{
    const data = snap.val() || {};
    impostorChat.innerHTML = '';
    Object.values(data).forEach(msg=>{
      const d = document.createElement('div');
      d.className = 'msg' + (msg.fromId===playerId ? ' self' : '');
      d.textContent = `${msg.fromName}: ${msg.text}`;
      impostorChat.appendChild(d);
    });
    impostorChat.scrollTop = impostorChat.scrollHeight;
  });

  // votes (update bars)
  db.ref('rooms/'+roomId+'/votes').on('value', snap=>{
    const data = snap.val() || {};
    updateVoteBars(data);
    // If voting active and all alive players voted -> finish votes
    if(votingActive){
      const aliveCount = players.filter(p=>p.alive).length;
      const votesCount = Object.keys(data).length;
      if(votesCount >= aliveCount){
        concludeVoting(data);
      }
    }
  });
}

/* ===========================
   Render UI helpers
   =========================== */
function renderPlayers(){
  playersListEl.innerHTML = '';
  playersCenterList.innerHTML = '';
  players.forEach(p=>{
    const li = document.createElement('li');
    li.textContent = p.name + (p.admin ? ' (admin)' : '') + (p.alive ? '' : ' ✖');
    playersListEl.appendChild(li);
    playersCenterList.appendChild(li.cloneNode(true));
  });
}

/* ===========================
   Start game: roles & words
   =========================== */
startGameBtn.addEventListener('click', async ()=>{
  if(!room) return alert('No estás en ninguna sala');
  if(!isAdmin) return alert('Sólo admin puede iniciar');
  // check players count
  const metaSnap = await db.ref('rooms/'+room+'/meta').once('value');
  const meta = metaSnap.val() || {};
  const required = meta.requiredPlayers || 4;
  if(players.length < required) return alert(`Se necesitan ${required} jugadores para iniciar`);
  // pick category
  const category = categorySelect.value || Object.keys(categories)[0];
  const wordsPool = (categories[category] || []).slice();
  // shuffle players
  const shuffled = players.slice().sort(()=>Math.random()-0.5);
  // impostor count: at least 1, roughly players/4
  const impostorCount = Math.max(1, Math.floor(shuffled.length / 4));
  const impostors = shuffled.slice(0, impostorCount).map(p=>p.id);
  // choose a secret word for civils and set category for impostors
  const secretWord = wordsPool.splice(Math.floor(Math.random()*wordsPool.length),1)[0];
  // assign
  const updates = {};
  shuffled.forEach((p,i)=>{
    if(impostors.includes(p.id)){
      updates['rooms/'+room+'/players/'+p.id+'/role'] = 'Impostor';
      updates['rooms/'+room+'/players/'+p.id+'/word'] = null;
    } else {
      // pick a distinct word if possible
      const w = wordsPool.length ? wordsPool.splice(Math.floor(Math.random()*wordsPool.length),1)[0] : secretWord;
      updates['rooms/'+room+'/players/'+p.id+'/role'] = 'Jugador';
      updates['rooms/'+room+'/players/'+p.id+'/word'] = w;
    }
    updates['rooms/'+room+'/players/'+p.id+'/alive'] = true;
    updates['rooms/'+room+'/players/'+p.id+'/votedFor'] = null;
  });
  // update meta: set category, status, set first turn to shuffled[0]
  updates['rooms/'+room+'/meta/category'] = category;
  updates['rooms/'+room+'/meta/status'] = 'playing';
  updates['rooms/'+room+'/meta/currentTurnPlayer'] = shuffled[0].id;
  updates['rooms/'+room+'/meta/turnEnd'] = now() + 60000; // 60s from now
  updates['rooms/'+room+'/meta/voting'] = false;
  // clear votes & chat
  updates['rooms/'+room+'/votes'] = null;
  updates['rooms/'+room+'/impostorChat'] = null;

  await db.ref().update(updates);
});

/* ===========================
   Timer and turns
   =========================== */
function startLocalTimer(){
  clearInterval(timerInterval);
  if(!turnEndTimestamp) { timerEl.textContent = '—'; return; }
  function tick(){
    const left = Math.max(0, Math.floor((turnEndTimestamp - now())/1000));
    timerEl.textContent = left + 's';
    if(left <= 0){
      clearInterval(timerInterval);
      // Only admin should advance turn automatically to avoid conflicts
      if(isAdmin) adminNextTurn();
    }
  }
  // initial set from stored timestamp by converting if turnEndTimestamp is number
  if(typeof turnEndTimestamp !== 'number'){
    // fetch fresh turnEnd from DB
    db.ref('rooms/'+room+'/meta/turnEnd').once('value').then(s=>{ turnEndTimestamp = s.val() || null; });
  }
  tick();
  timerInterval = setInterval(()=>{ 
    // refreshing cached turnEnd (in case admin updated)
    db.ref('rooms/'+room+'/meta/turnEnd').once('value').then(s=>{ turnEndTimestamp = s.val(); tick(); });
  }, 1000);
}

nextTurnBtn.addEventListener('click', ()=>{
  if(!isAdmin) return alert('Solo admin puede cambiar turno');
  adminNextTurn();
});

// ===========================
// Turnos y activación de votación
function adminNextTurn(){
  if(!room) return;
  const metaRef = db.ref('rooms/'+room+'/meta');
  metaRef.once('value').then(snap=>{
    const m = snap.val() || {};
    const cur = m.currentTurnPlayer || null;
    const alive = players.filter(p=>p.alive).map(p=>p.id);
    if(alive.length === 0) return;

    let idx = alive.indexOf(cur); 
    if(idx < 0) idx=0;
    const nextIdx = (idx+1) % alive.length;
    const nextId = alive[nextIdx];

    let turnsPerPlayer = m.turnsPerPlayer || {};
    alive.forEach(id => { if(!turnsPerPlayer[id]) turnsPerPlayer[id]=0; });

    if(cur) turnsPerPlayer[cur]++;

    const allDone = alive.every(id => turnsPerPlayer[id] >= 2);

    const updates = {
      currentTurnPlayer: nextId,
      turnEnd: now()+60000,
      turnsPerPlayer: turnsPerPlayer
    };

    if(allDone){
      updates.voting = true; // habilita votación
      Object.keys(turnsPerPlayer).forEach(id => turnsPerPlayer[id]=0); // reinicia
      updates.turnsPerPlayer = turnsPerPlayer;
    }

    metaRef.update(updates);
  });
}

/* ===========================
   Chat impostores
   =========================== */
sendImpostor.addEventListener('click', ()=>{
  const text = impostorMsg.value.trim();
  if(!text || !room) return;
  db.ref('rooms/'+room+'/impostorChat').push({
    fromId: playerId,
    fromName: playerName,
    text: text,
    ts: now()
  });
  impostorMsg.value = '';
});

/* ===========================
   Voting
   =========================== */
enableVoteBtn.addEventListener('click', ()=>{
  if(!isAdmin) return alert('Solo admin puede forzar votación');
  db.ref('rooms/'+room+'/meta').update({ voting: true });
  // clear previous votes
  db.ref('rooms/'+room+'/votes').set(null);
  votingActive = true;
  votingStatus.textContent = 'Activa';
  buildVoteUI();
});

function buildVoteUI(){
  voteRows.innerHTML='';
  players.filter(p=>p.alive).forEach(p=>{
    const row = document.createElement('div');
    row.className='voteRow'; 
    row.dataset.target=p.id;
    row.innerHTML=`<div class="voteName">${p.name}</div>
                   <div class="voteBar"><div class="voteFill"></div></div>
                   <div class="voteCount">0</div>`;
    row.addEventListener('click', ()=>{
      if(!votingActive) return; // solo se puede votar cuando está activa
      if(p.id===playerId) return;
      myVote=p.id;
      Array.from(voteRows.children).forEach(r=>r.classList.remove('active'));
      row.classList.add('active');
      voteSubmitBtn.disabled=false;
    });
    voteRows.appendChild(row);
  });
  voteSubmitBtn.disabled = true; // al inicio siempre deshabilitado
}

voteSubmitBtn.addEventListener('click', ()=>{
  if(!myVote || !room) return;
  db.ref('rooms/'+room+'/votes/'+playerId).set(myVote);
  voteSubmitBtn.disabled = true;
});

/* update vote bars based on votes object */
function updateVoteBars(votesObj){
  const counts = {};
  Object.values(votesObj || {}).forEach(v=> counts[v] = (counts[v]||0)+1);
  Array.from(voteRows.children).forEach(row=>{
    const id = row.dataset.target;
    const count = counts[id] || 0;
    const pct = Math.round((count / Math.max(1, players.filter(p=>p.alive).length)) * 100);
    row.querySelector('.voteFill').style.width = pct + '%';
    row.querySelector('.voteCount').textContent = count;
  });
}

/* conclude voting: eliminate highest vote (ties: no elimination) */
async function concludeVoting(votesObj){
  if(!room) return;
  // Only run once - flip voting meta to false
  const metaSnap = await db.ref('rooms/'+room+'/meta').once('value');
  const meta = metaSnap.val() || {};
  if(!meta.voting) return; // already processed
  // count
  const counts = {};
  Object.values(votesObj || {}).forEach(v=> counts[v] = (counts[v]||0)+1);
  let max = 0, candidate = null;
  for(const id in counts){
    if(counts[id] > max){ max = counts[id]; candidate = id; }
    else if(counts[id] === max) candidate = null; // tie -> no elimination
  }
  const updates = {};
  if(candidate){
    updates['rooms/'+room+'/players/'+candidate+'/alive'] = false;
  }
  updates['rooms/'+room+'/meta/voting'] = false;
  updates['rooms/'+room+'/votes'] = null;
  // clear players' votedFor fields
  Object.keys(players || {}).forEach(p=>{
    // handled by players listener if needed; optional
  });
  await db.ref().update(updates);
  votingActive = false;
  votingStatus.textContent = 'Bloqueada';
  voteRows.innerHTML = '';
}

/* ===========================
   Detect player changes and update local UI
   =========================== */
db.ref().on('value', ()=>{}); // keep connection alive (optional)

/* Watch players to update role/word display for me and rounds */
setInterval(()=>{ // fallback refresh UI frequently
  const me = players.find(p=>p.id===playerId);
  if(me){
    roleDisplay.textContent = me.role || '—';
    wordDisplay.textContent = (me.role==='Impostor') ? ('Categoría: ' + (categorySelect.value || '—')) : (me.word || '—');
    impostorChatContainer.style.display = (me.role==='Impostor') ? 'block' : 'none';
  }
  // rounds completed
  const rounds = parseInt(roundInfoEl.dataset.rounds || '0');
  roundInfoEl.textContent = 'Rondas completadas: ' + rounds;
}, 800);

/* ===========================
   Finalizar / Reiniciar
   =========================== */
endGameBtn.addEventListener('click', ()=>{
  if(!isAdmin) return alert('Solo admin puede finalizar');
  if(!room) return;
  db.ref('rooms/'+room).remove();
  location.reload();
});

/* ===========================
   When votes / meta / players change, update some local things
   =========================== */
db.ref().on('value', snapshot=>{
  if(!room) return;
  const meta = (snapshot.child('rooms/'+room+'/meta').val()) || {};
  currentTurn = meta.currentTurnPlayer || null;
  turnEndTimestamp = meta.turnEnd || null;
  const rounds = parseInt(roundInfoEl.dataset.rounds || '0');
  // If a turn changed, update rounds count when currentTurn back to first alive player
  // (we keep it simple: increment rounds when admin clicks next and currentTurn wraps)
  // Start local timer
  if(turnEndTimestamp) startLocalTimer();
  // update turn display
  const p = players.find(x=>x.id===currentTurn);
  $('turnInfo').textContent = p ? p.name : '—';
});

/* ===========================
   Keyboard shortcut: quick join if URL has room
   =========================== */
window.addEventListener('load', ()=>{
  const params = new URLSearchParams(window.location.search);
  if(params.has('room')){
    // populate join field
    joinRoomInput.value = params.get('room');
  }
});
</script>
</body>
</html>

